<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Times - Speedrun</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #2c2c2c;
            font-family: 'Arial', sans-serif;
            color: white;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #4facfe;
            margin-bottom: 10px;
        }

        .username {
            text-align: center;
            color: #ccc;
            margin-bottom: 40px;
            font-size: 18px;
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-buttons button {
            margin: 0 10px;
            padding: 12px 24px;
            background: rgba(79, 172, 254, 0.3);
            color: #4facfe;
            border: 2px solid #4facfe;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-buttons button:hover {
            background: rgba(79, 172, 254, 0.5);
        }

        .times-grid {
            display: grid;
            gap: 20px;
        }

        .time-card {
            background: rgba(0,0,0,0.5);
            border: 2px solid #4facfe;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-info {
            flex: 1;
        }

        .map-name {
            font-size: 24px;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }

        .time-value {
            font-size: 32px;
            font-family: 'Courier New', monospace;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .rank-info {
            color: #ccc;
            font-size: 14px;
        }

        .delete-btn {
            padding: 12px 24px;
            background: rgba(255, 0, 0, 0.3);
            color: #ff4444;
            border: 2px solid #ff4444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 0, 0.5);
        }

        .no-times {
            text-align: center;
            padding: 60px 20px;
            color: #888;
            font-size: 18px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #4facfe;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š My Times</h1>
        <div class="username" id="username">Loading...</div>

        <div class="nav-buttons">
            <button onclick="window.location.href='game.html'">Back to Game</button>
            <button onclick="window.location.href='index.html'">Main Page</button>
        </div>

        <div id="loading" class="loading">Loading your times...</div>
        <div id="times-container" class="times-grid" style="display: none;"></div>
        <div id="no-times" class="no-times" style="display: none;">You haven't set any times yet. Play the game to set some records!</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBLkFMipRS631fDNr8uwgozmxXBnqLd5_o",
            authDomain: "base-control-b391e.firebaseapp.com",
            databaseURL: "https://base-control-b391e-default-rtdb.firebaseio.com",
            projectId: "base-control-b391e",
            storageBucket: "base-control-b391e.firebasestorage.app",
            messagingSenderId: "116375376675",
            appId: "1:116375376675:web:cdc8688222c7c35accf296",
            measurementId: "G-JY7P6D49HM"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let currentUsername = '';

        // Map definitions (same as game.html)
        const maps = [
            { id: 'custom_level', name: 'Original Map' }
        ];

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = ms % 1000;
            return `${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
        }

        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUser = user;
                const userSnapshot = await database.ref('users/' + user.uid).once('value');
                const userData = userSnapshot.val();

                if (userData && userData.username) {
                    currentUsername = userData.username;
                } else {
                    // Extract username from email (format: username@speedrun.local)
                    currentUsername = user.email.split('@')[0];

                    // Save username to database for future use
                    await database.ref('users/' + user.uid).set({
                        username: currentUsername,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                document.getElementById('username').textContent = `ðŸ‘¤ ${currentUsername}`;
                loadTimes();
            }
        });

        async function loadTimes() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('times-container').style.display = 'none';
            document.getElementById('no-times').style.display = 'none';

            const timesContainer = document.getElementById('times-container');
            timesContainer.innerHTML = '';

            let hasAnyTimes = false;

            // Load all times from history
            const historySnapshot = await database.ref('times_history/' + currentUser.uid).once('value');
            const allTimes = [];

            if (historySnapshot.exists()) {
                historySnapshot.forEach((mapSnapshot) => {
                    const mapId = mapSnapshot.key;
                    const mapName = maps.find(m => m.id === mapId)?.name || mapId;

                    mapSnapshot.forEach((timeSnapshot) => {
                        const timeData = timeSnapshot.val();
                        allTimes.push({
                            id: timeSnapshot.key,
                            mapId: mapId,
                            mapName: mapName,
                            time: timeData.time,
                            timestamp: timeData.timestamp,
                            username: timeData.username
                        });
                    });
                });
            } else {
                // Fallback: Load from old scores database if no history exists
                for (const map of maps) {
                    const scoreSnapshot = await database.ref('scores/' + map.id + '/' + currentUser.uid).once('value');
                    if (scoreSnapshot.exists()) {
                        const scoreData = scoreSnapshot.val();
                        allTimes.push({
                            id: 'legacy',
                            mapId: map.id,
                            mapName: map.name,
                            time: scoreData.time,
                            timestamp: scoreData.timestamp || Date.now(),
                            username: scoreData.username
                        });
                    }
                }
            }

            // Sort by timestamp (newest first)
            allTimes.sort((a, b) => b.timestamp - a.timestamp);

            if (allTimes.length > 0) {
                hasAnyTimes = true;

                for (const timeEntry of allTimes) {
                    const date = new Date(timeEntry.timestamp);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                    const card = document.createElement('div');
                    card.className = 'time-card';
                    card.innerHTML = `
                        <div class="time-info">
                            <div class="map-name">${timeEntry.mapName}</div>
                            <div class="time-value">${formatTime(timeEntry.time)}</div>
                            <div class="rank-info">Date: ${dateStr}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteTime('${timeEntry.mapId}', '${timeEntry.id}', '${timeEntry.mapName}')">Delete</button>
                    `;
                    timesContainer.appendChild(card);
                }
            }

            document.getElementById('loading').style.display = 'none';

            if (hasAnyTimes) {
                document.getElementById('times-container').style.display = 'grid';
            } else {
                document.getElementById('no-times').style.display = 'block';
            }
        }

        async function deleteTime(mapId, timeId, mapName) {
            const password = prompt(`Enter your password to delete this time for ${mapName}:`);
            if (!password) return;

            try {
                const email = currentUser.email;
                const credential = firebase.auth.EmailAuthProvider.credential(email, password);

                await currentUser.reauthenticateWithCredential(credential);

                // Delete the time from history
                if (timeId !== 'legacy') {
                    await database.ref('times_history/' + currentUser.uid + '/' + mapId + '/' + timeId).remove();
                }

                // Get all remaining times for this map to find new best
                const remainingTimes = [];
                const mapTimesSnapshot = await database.ref('times_history/' + currentUser.uid + '/' + mapId).once('value');

                mapTimesSnapshot.forEach((timeSnapshot) => {
                    remainingTimes.push(timeSnapshot.val());
                });

                if (remainingTimes.length > 0) {
                    // Find best time and update scores
                    const bestTime = Math.min(...remainingTimes.map(t => t.time));
                    const bestTimeData = remainingTimes.find(t => t.time === bestTime);

                    await database.ref('scores/' + mapId + '/' + currentUser.uid).set({
                        username: currentUsername,
                        time: bestTime,
                        timestamp: bestTimeData.timestamp
                    });
                } else {
                    // No times left, remove from global leaderboard
                    await database.ref('scores/' + mapId + '/' + currentUser.uid).remove();
                }

                alert('Time deleted successfully!');

                // Reload times
                loadTimes();
            } catch (error) {
                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    alert('Incorrect password');
                } else {
                    alert('Error deleting time: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
